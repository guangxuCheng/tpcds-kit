--TPC-DS Q8
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48906','24057','99460','91195','14256','40865',
                          '69948','44384','84195','52438','59136',
                          '32478','12728','19288','71965','91442',
                          '30672','61342','31508','17623','33626',
                          '89457','78835','26912','38497','83508',
                          '71461','91734','13504','36697','32387',
                          '33335','96698','49771','35211','71957',
                          '39473','19868','62799','23043','80225',
                          '84418','95394','37917','39234','18680',
                          '57612','21805','74311','61995','73633',
                          '40165','68432','90983','98265','73290',
                          '72210','74434','20528','58831','97142',
                          '12502','78720','89434','88509','39314',
                          '80404','14417','52361','76567','64254',
                          '78736','35822','39215','61013','49187',
                          '56194','78687','78568','51903','76518',
                          '30090','38667','84401','54466','64709',
                          '65756','98513','15039','22519','23248',
                          '95587','66778','12733','33033','37792',
                          '40236','70784','66996','40202','14492',
                          '25976','17567','46115','68957','91203',
                          '56738','52044','63336','55238','71835',
                          '83869','15068','34551','99640','46659',
                          '23881','37825','60005','13403','77949',
                          '40517','89233','51987','57412','25477',
                          '90431','31942','62442','72159','32711',
                          '83109','87676','64248','56240','34245',
                          '71185','41713','84937','37501','78730',
                          '61072','87155','50599','88375','88560',
                          '75409','23322','39405','13797','68553',
                          '16958','69252','66150','41012','47999',
                          '44628','30094','23032','61645','77361',
                          '94802','95769','88157','79957','35958',
                          '76340','91698','86678','97469','43071',
                          '32401','75459','76998','56506','46298',
                          '32951','88283','92818','20003','76401',
                          '22900','33322','39151','86433','31825',
                          '99427','70388','43279','33590','95664',
                          '31892','87785','88327','38789','95591',
                          '83776','50170','94838','65428','27198',
                          '23469','57103','77052','68694','24755',
                          '93957','50149','18905','79196','34123',
                          '87278','92390','40748','43953','69480',
                          '22468','28840','12739','77946','48214',
                          '60189','19298','57460','90001','32756',
                          '58329','14314','38696','11874','60219',
                          '52590','61448','25289','53520','44529',
                          '14750','67455','38735','86031','66185',
                          '43679','27311','49593','34037','94443',
                          '57417','85410','10201','38783','41530',
                          '62898','81417','32188','52876','83614',
                          '62177','38833','62893','17545','85226',
                          '94990','87412','23315','26845','30833',
                          '29470','89428','64179','78754','32566',
                          '26756','48657','86258','14443','26227',
                          '48518','72482','48993','21707','90396',
                          '23471','81338','38476','87896','23729',
                          '10017','20122','81158','18307','39137',
                          '72112','46642','90048','75501','20449',
                          '99779','96839','22214','63990','76035',
                          '24898','81923','78888','55073','51119',
                          '81167','31981','69798','24307','94457',
                          '37275','19847','62109','14609','25001',
                          '79417','10537','75624','32114','68518',
                          '13084','70919','69423','92027','33813',
                          '39672','36292','12817','15306','87643',
                          '70742','74605','69558','64493','41101',
                          '75334','51936','96427','61555','62548',
                          '15151','69903','95294','71389','56197',
                          '82307','44827','84658','56801','25669',
                          '39461','67436','29330','90616','66844',
                          '64124','67580','97427','55183','64524',
                          '10852','35559','20527','57262','93386',
                          '22966','51906','11857','73557','52417',
                          '13364','95460','41606','83405','41668',
                          '16203','27481','83273','35399','58050',
                          '73366','77823','78520','11244','48553',
                          '94019','89202','80369','57083','31999',
                          '30609','62230','36001','54589','69350',
                          '41974','40029','52578','26840')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

