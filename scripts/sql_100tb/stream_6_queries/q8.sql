--TPC-DS Q8
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16581','17509','43349','95211','45754','28134',
                          '40649','22863','39399','99793','48978',
                          '26744','61495','22948','32757','38352',
                          '30196','97652','48848','33167','52330',
                          '25074','57982','11501','82099','88457',
                          '62820','19109','15033','71227','64286',
                          '88952','38796','88278','68349','50068',
                          '50583','17945','48131','37912','81220',
                          '93990','97385','14329','30669','90816',
                          '24835','10097','34090','90105','82961',
                          '53155','16341','25575','32437','42638',
                          '38280','68340','28491','40673','86760',
                          '72475','72330','13296','24381','31896',
                          '25856','47130','46608','10644','71734',
                          '86146','77526','80479','55680','45643',
                          '24770','19989','96073','89151','72565',
                          '75733','79415','24769','30100','27457',
                          '65367','71041','78257','34044','68740',
                          '61106','38735','15286','63697','31219',
                          '34337','59452','52738','61770','72944',
                          '30352','54924','11673','56672','28168',
                          '22669','61182','10567','93634','93986',
                          '65022','37772','54971','81026','21352',
                          '70056','57102','56800','66174','44524',
                          '25294','60554','82580','22284','96848',
                          '10395','60434','19712','89292','24595',
                          '30502','90671','94543','68936','97684',
                          '68727','79397','96105','36223','72029',
                          '86110','16415','45607','58774','57737',
                          '66493','75612','22355','76188','58610',
                          '36772','48568','25121','34531','65717',
                          '36477','45253','73529','14530','46353',
                          '28471','12107','67585','44291','25285',
                          '73063','78220','32624','30285','38562',
                          '45842','72133','46914','50892','73724',
                          '87674','98511','19757','61056','29677',
                          '65583','28435','34435','69207','89083',
                          '10098','53228','80900','17679','32620',
                          '17116','32565','42172','55647','21482',
                          '96467','34835','66801','55815','63129',
                          '97927','22109','48340','76311','17096',
                          '51818','28572','23440','61544','11064',
                          '44221','80899','43559','39787','79691',
                          '84275','97469','70437','93156','28839',
                          '94628','33270','80807','58683','20501',
                          '45185','65471','56467','59559','69295',
                          '12501','98693','53387','54028','86565',
                          '26732','44928','78147','87202','72139',
                          '85898','63361','75609','85763','31425',
                          '10960','51383','41317','56174','91703',
                          '56109','42310','74406','47224','28171',
                          '97616','13213','99716','33975','61081',
                          '32984','74885','16362','71811','42923',
                          '82813','94735','92442','31287','11863',
                          '16292','66525','70307','85282','56760',
                          '16344','72892','38750','32765','89630',
                          '37265','52615','38037','26377','10556',
                          '94708','16701','75293','77054','51550',
                          '64109','58621','94595','69655','48687',
                          '14093','37225','74043','30368','52613',
                          '30054','51216','66626','38940','79653',
                          '40908','66625','84036','94754','24604',
                          '63746','23955','90400','24510','74540',
                          '91819','49559','32788','59995','16202',
                          '36254','17188','85265','61797','91989',
                          '30964','70397','93002','37960','77216',
                          '57598','52064','16975','99955','47733',
                          '14252','69929','32669','39601','31378',
                          '16049','12465','40137','58248','24633',
                          '84188','42400','68830','11512','77575',
                          '58712','48897','17956','65474','18182',
                          '80997','94145','22949','61075','79841',
                          '14527','44457','66041','25265','44301',
                          '82803','38866','23303','49625','53181',
                          '15211','86443','15051','17985','39085',
                          '67105','97742','85924','59410','29786',
                          '18600','90513','24623','67300','84104',
                          '71242','61454','83222','91866','50052',
                          '65511','86827','43551','18491','85419',
                          '61790','98721','65589','93495')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

