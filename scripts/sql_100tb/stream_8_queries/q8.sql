--TPC-DS Q8
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27653','82154','67169','27154','95944','81566',
                          '50879','39257','43392','50564','84563',
                          '33683','70171','40766','20440','57009',
                          '64947','61992','87081','31523','40936',
                          '89249','14722','52182','10630','26707',
                          '57934','40776','72737','51766','26615',
                          '97334','27688','94471','99232','39442',
                          '95581','75682','44007','41562','17999',
                          '39152','87535','84910','94391','37138',
                          '78245','99473','35711','99893','77504',
                          '37979','29355','95224','16868','79497',
                          '28724','34577','18481','74897','14945',
                          '31567','89332','22049','11167','85059',
                          '39571','90724','94864','44123','36402',
                          '78575','34642','99621','84585','45100',
                          '32829','27926','50394','89656','84241',
                          '57029','66837','28077','36836','51265',
                          '83525','53137','26445','36881','23877',
                          '96788','93635','50761','75843','31853',
                          '70557','38972','93282','27931','67007',
                          '70725','57250','41566','68705','67078',
                          '18429','54110','79483','32845','73312',
                          '71185','52413','24930','35999','96352',
                          '91846','56787','78911','58136','52279',
                          '91540','12988','94224','31075','69838',
                          '95677','37777','78845','46683','98347',
                          '72308','38724','61832','46283','22404',
                          '31176','15227','32780','47036','29681',
                          '19624','80626','15700','89528','47593',
                          '29687','45366','13244','91892','28840',
                          '36277','93890','71050','84905','77883',
                          '20154','64604','21759','60479','17592',
                          '97416','30185','40788','11800','80526',
                          '92066','81376','45829','39661','61909',
                          '17462','46350','88416','91069','22338',
                          '65947','67031','13112','18133','64699',
                          '12509','59515','87194','70965','33021',
                          '90566','75444','54474','48953','33434',
                          '61749','35206','14833','54588','45975',
                          '84135','47463','67220','55007','21061',
                          '14616','56629','20028','72983','25515',
                          '60805','43468','86028','39681','99772',
                          '38737','84120','74233','53632','32258',
                          '27674','55725','83861','33767','57437',
                          '14927','54601','49969','47619','49303',
                          '61659','18178','83990','67049','37666',
                          '52696','45010','55664','27424','32942',
                          '65275','37083','21836','22027','90485',
                          '29092','22145','47205','75997','15642',
                          '73169','98043','88371','94671','89559',
                          '44503','50238','46745','74858','54290',
                          '44158','50824','77049','60046','96339',
                          '50874','76950','53568','37859','95775',
                          '90658','88265','91014','91411','71875',
                          '81347','70712','13375','50077','83297',
                          '41546','37253','60390','78141','51722',
                          '33435','13919','65159','75534','95976',
                          '83357','41274','46077','40046','54685',
                          '42159','34459','64982','40161','48071',
                          '43645','37081','39987','52056','80864',
                          '55014','97379','50278','10221','86846',
                          '96281','93276','81053','86231','26062',
                          '55372','26612','99653','59284','66737',
                          '97862','41169','74236','54559','11159',
                          '21604','96373','97247','67008','79464',
                          '71387','41704','12293','43365','19282',
                          '76999','74685','27442','55185','28269',
                          '93757','55747','11029','66085','46550',
                          '72364','98127','77281','75618','84300',
                          '15405','40836','41968','19158','72024',
                          '51830','55731','81903','13293','12691',
                          '51361','64521','94133','60681','44625',
                          '37442','33848','65754','94266','60773',
                          '39407','46636','47363','39988','24533',
                          '81619','89790','99526','91392','61414',
                          '24341','38519','32309','18735','22271',
                          '98110','72801','49989','80667','28737',
                          '93717','55042','69880','55775','48026',
                          '40759','59274','28173','46012','95695',
                          '31340','35029','55660','81090')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

