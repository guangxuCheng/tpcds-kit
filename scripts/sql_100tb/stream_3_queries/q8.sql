--TPC-DS Q8
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69068','26481','92649','20559','57044','46397',
                          '16384','39739','86241','42251','20905',
                          '67410','93714','26683','43167','77410',
                          '83131','85263','75926','21161','46339',
                          '41096','67790','58242','92098','43686',
                          '75858','34279','37023','77430','97499',
                          '86267','10063','54654','76099','83674',
                          '19068','28031','56546','40513','99861',
                          '50568','56592','54353','99374','91554',
                          '64149','77194','65387','87248','24962',
                          '75692','26450','30268','32954','68575',
                          '66382','31166','78634','53763','94975',
                          '98908','24732','34202','97373','49074',
                          '70424','12069','72093','71481','43202',
                          '11222','32844','41013','59946','31534',
                          '61804','30104','30731','63686','68583',
                          '73721','98514','97246','90278','19267',
                          '93806','56963','59694','12767','97899',
                          '56933','47808','42159','72773','22599',
                          '73241','93920','73134','79996','49717',
                          '97440','36521','69809','97548','72287',
                          '21829','43584','56486','18653','97956',
                          '87277','58973','40508','60738','82416',
                          '33742','98175','99912','81609','87859',
                          '87210','67332','56401','42683','25216',
                          '29434','89417','49742','35623','63474',
                          '33464','98879','68329','20868','71631',
                          '49797','66368','90285','22284','35657',
                          '97759','50614','26673','71778','90030',
                          '27618','42635','24969','99247','65751',
                          '10657','35670','17825','62016','90406',
                          '44261','26908','74194','17685','42230',
                          '82199','41825','76699','21568','10103',
                          '29758','44483','62017','27168','60798',
                          '69786','15983','74879','17303','88075',
                          '48623','94983','89423','67315','28301',
                          '98170','80339','97871','33137','54354',
                          '43849','10894','13328','12178','14275',
                          '62882','36372','93657','77828','76853',
                          '50478','79823','52648','70077','49925',
                          '60070','50745','69950','67086','54876',
                          '14570','45023','30551','44820','40899',
                          '21977','44324','42759','93696','39020',
                          '65372','32734','80893','43354','50175',
                          '22263','44908','36570','66870','33156',
                          '46347','39740','26008','33262','45377',
                          '31918','22554','57250','98050','87927',
                          '76796','99396','87542','79573','59679',
                          '44224','21590','39618','74183','57707',
                          '27720','85849','87428','15823','64289',
                          '16079','63385','70824','96198','69012',
                          '89354','60943','47544','39348','55981',
                          '48970','10290','65700','99014','36991',
                          '11753','77814','58844','25581','17833',
                          '85753','76968','57650','46531','36069',
                          '81358','52593','79779','36623','37408',
                          '52137','70402','50076','39608','81675',
                          '69652','24550','95988','25607','93870',
                          '23039','59149','26981','32332','35643',
                          '70873','20428','27338','83951','17282',
                          '88423','74431','65881','31141','41206',
                          '19104','49728','39564','79872','31521',
                          '82049','40598','29451','92437','85634',
                          '50515','87263','28374','45708','84651',
                          '93217','47445','83621','79003','53961',
                          '56179','82685','71787','36332','61448',
                          '73593','93646','48893','70677','18432',
                          '83179','56346','61027','95795','69496',
                          '12895','78112','96167','45227','73166',
                          '46985','55126','31706','38198','62997',
                          '31295','71941','75787','15231','70521',
                          '44623','92773','66386','22833','92229',
                          '59147','50393','50434','37730','27954',
                          '20712','45484','28400','83248','51391',
                          '44721','41582','93092','24417','99449',
                          '51656','62967','57923','33144','93472',
                          '49602','11317','78834','50459','58298',
                          '40905','84414','63956','86041','63431',
                          '11944','82145','93053','17999','93767',
                          '65818','85728','11148','36025')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

